import sys
import ast
import math

def distance(p0, p1):
        p0 = map(float, p0)
        p1 = map(float, p1)
        return math.sqrt((p0[0] - p1[0])**2 + (p0[1] - p1[1])**2)

def make_gcode(component, e, out_name, offset, ext_fil_ratio):
    with open(out_name, 'a') as out:
        prev = component[0]
        out.write("G1 X%.4f Y%.4f F7800.00\n" % (prev[0] + offset[0], prev[1] + offset[1]))
        out.write("G1 E%.4f F1800.00\n" % e)
        for coords in component[1:]:
            e += distance(prev, coords) / float(ext_fil_ratio)
            out.write("G1 X%.4f Y%.4f E%.4f\n" % (coords[0] + offset[0], coords[1] + offset[1], e))
            prev = coords
        out.write("G1 F1800.000 E%.4f\n" % (e-.2))
    return e

def write_prelude(out_name):
    with open(out_name, 'a') as out:    
        prelude ='''G21 ; set units to millimeters
M107
M104 S200 ; set temperature
G28 X0 Y0; home all axes
G29 ; probe tilt
G1 Z5 F5000 ; lift nozzle
M109 S200 ; wait for temperature to be reached
G90 ; use absolute coordinates
M82 ; use absolute distances for extrusion

G92 E0
G1 Z0.350 F7800.000
G1 X37.940 Y37.390
G1 F1800.000 E1.00000
G1 X38.350 Y36.990 F540.000 E1.05298
G1 X38.790 Y36.620 E1.10615
G1 X41.090 Y34.990 E1.36689
G1 X41.370 Y34.820 E1.39718
G1 X41.960 Y34.510 E1.45883
G1 X42.580 Y34.260 E1.52066
G1 X47.310 Y32.810 E1.97823
G1 X47.910 Y32.680 E2.03502
G1 X48.520 Y32.600 E2.09192
G1 X49.140 Y32.580 E2.14929
G1 X50.850 Y32.580 E2.30745
G1 X51.470 Y32.600 E2.36483
G1 X52.080 Y32.680 E2.42173
G1 X52.680 Y32.810 E2.47851
G1 X52.980 Y32.900 E2.50748
G1 X57.410 Y34.260 E2.93609
G1 X58.030 Y34.510 E2.99792
G1 X58.330 Y34.660 E3.02894
G1 X58.900 Y34.990 E3.08986
G1 X59.180 Y35.180 E3.12116
G1 X61.200 Y36.620 E3.35060
G1 X61.840 Y37.180 E3.42926
G1 X63.250 Y38.660 E3.61832
G1 X63.940 Y39.510 E3.71958
G1 X64.820 Y40.780 E3.86249
G1 X65.380 Y41.750 E3.96608
G1 X66.000 Y43.030 E4.09763
G1 X66.360 Y43.920 E4.18642
G1 X66.780 Y45.190 E4.31014
G1 X67.020 Y46.120 E4.39898
G1 X67.260 Y47.390 E4.51852
G1 X67.380 Y48.280 E4.60158
G1 X67.460 Y49.550 E4.71928
G1 X67.460 Y50.470 E4.80437
G1 X67.380 Y51.740 E4.92207
G1 X67.250 Y52.680 E5.00984
G1 X67.000 Y53.950 E5.12955
G1 X66.770 Y54.830 E5.21368
G1 X66.350 Y56.100 E5.33740
G1 X65.960 Y57.050 E5.43238
G1 X65.330 Y58.320 E5.56350
G1 X64.810 Y59.210 E5.65884
G1 X63.930 Y60.490 E5.80251
G1 X63.200 Y61.390 E5.90969
G1 X61.990 Y62.660 E6.07193
G1 X61.580 Y63.060 E6.12491
G1 X60.910 Y63.590 E6.20393
G1 X58.820 Y65.050 E6.43973
G1 X57.930 Y65.530 E6.53325
G1 X57.310 Y65.780 E6.59508
G1 X52.710 Y67.150 E7.03901
G1 X52.030 Y67.320 E7.10384
G1 X51.690 Y67.380 E7.13577
G1 X50.990 Y67.440 E7.20075
G1 X49.350 Y67.450 E7.35244
G1 X48.650 Y67.420 E7.41724
G1 X47.960 Y67.320 E7.48173
G1 X47.280 Y67.150 E7.54656
G1 X42.680 Y65.780 E7.99049
G1 X42.360 Y65.660 E8.02210
G1 X41.750 Y65.380 E8.08418
G1 X41.160 Y65.040 E8.14716
G1 X38.850 Y63.420 E8.40811
G1 X38.220 Y62.870 E8.48546
G1 X36.810 Y61.410 E8.67319
G1 X36.060 Y60.490 E8.78298
G1 X35.180 Y59.210 E8.92665
G1 X34.660 Y58.320 E9.02198
G1 X34.030 Y57.050 E9.15311
G1 X33.640 Y56.100 E9.24809
G1 X33.220 Y54.830 E9.37181
G1 X32.970 Y53.850 E9.46535
G1 X32.740 Y52.580 E9.58473
G1 X32.640 Y51.790 E9.65838
G1 X32.550 Y50.520 E9.77614
G1 X32.540 Y49.550 E9.86586
G1 X32.620 Y48.280 E9.98355
G1 X32.730 Y47.440 E10.06191
G1 X32.960 Y46.170 E10.18128
G1 X33.210 Y45.190 E10.27483
G1 X33.630 Y43.920 E10.39855
G1 X33.990 Y43.030 E10.48734
G1 X34.610 Y41.750 E10.61889
G1 X35.170 Y40.780 E10.72248
G1 X36.050 Y39.510 E10.86539
G1 X36.740 Y38.660 E10.96665
G1 X37.875 Y37.459 E11.11944
G1 X38.410 Y37.820 F7800.000
G1 X38.780 Y37.460 F540.000 E11.16718
G1 X39.180 Y37.120 E11.21574
G1 X41.430 Y35.530 E11.47056
G1 X41.960 Y35.220 E11.52735
G1 X42.790 Y34.860 E11.61103
G1 X47.200 Y33.500 E12.03787
G1 X47.840 Y33.340 E12.09888
G1 X48.810 Y33.220 E12.18928
G1 X51.180 Y33.220 E12.40849
G1 X52.150 Y33.340 E12.49889
G1 X52.790 Y33.500 E12.55990
G1 X56.910 Y34.760 E12.95839
G1 X57.480 Y34.970 E13.01457
G1 X58.030 Y35.220 E13.07045
G1 X58.300 Y35.370 E13.09902
G1 X58.810 Y35.700 E13.15520
G1 X60.810 Y37.120 E13.38207
G1 X61.400 Y37.640 E13.45481
G1 X62.780 Y39.090 E13.63995
G1 X63.410 Y39.870 E13.73268
G1 X64.290 Y41.140 E13.87559
G1 X64.810 Y42.030 E13.97093
G1 X65.430 Y43.310 E14.10247
G1 X65.760 Y44.120 E14.18337
G1 X66.180 Y45.390 E14.30709
G1 X66.400 Y46.240 E14.38830
G1 X66.640 Y47.510 E14.50784
G1 X66.740 Y48.320 E14.58333
G1 X66.820 Y49.590 E14.70102
G1 X66.820 Y50.430 E14.77872
G1 X66.740 Y51.700 E14.89641
G1 X66.630 Y52.560 E14.97660
G1 X66.380 Y53.830 E15.09632
G1 X66.170 Y54.630 E15.17282
G1 X65.750 Y55.900 E15.29654
G1 X65.390 Y56.770 E15.38363
G1 X64.760 Y58.040 E15.51475
G1 X64.290 Y58.850 E15.60136
G1 X63.410 Y60.130 E15.74503
G1 X62.740 Y60.950 E15.84297
G1 X61.530 Y62.220 E16.00521
G1 X61.160 Y62.580 E16.05296
G1 X60.750 Y62.920 E16.10222
G1 X58.480 Y64.510 E16.35856
G1 X57.940 Y64.820 E16.41615
G1 X57.670 Y64.950 E16.44387
G1 X57.100 Y65.180 E16.50072
G1 X52.530 Y66.540 E16.94172
G1 X51.910 Y66.690 E17.00072
G1 X51.590 Y66.750 E17.03083
G1 X50.960 Y66.810 E17.08936
G1 X49.030 Y66.810 E17.26787
G1 X48.400 Y66.750 E17.32640
G1 X47.460 Y66.540 E17.41549
G1 X43.180 Y65.270 E17.82841
G1 X42.890 Y65.180 E17.85649
G1 X42.310 Y64.950 E17.91420
G1 X41.770 Y64.660 E17.97089
G1 X41.240 Y64.330 E18.02864
G1 X39.240 Y62.910 E18.25551
G1 X38.660 Y62.420 E18.32573
G1 X37.260 Y60.970 E18.51215
G1 X36.580 Y60.130 E18.61211
G1 X35.700 Y58.850 E18.75578
G1 X35.230 Y58.040 E18.84240
G1 X34.600 Y56.770 E18.97352
G1 X34.240 Y55.900 E19.06060
G1 X33.820 Y54.630 E19.18432
G1 X33.590 Y53.730 E19.27024
G1 X33.360 Y52.460 E19.38961
G1 X33.270 Y51.750 E19.45581
G1 X33.180 Y50.480 E19.57357
G1 X33.180 Y49.590 E19.65588
G1 X33.260 Y48.320 E19.77358
G1 X33.350 Y47.560 E19.84436
G1 X33.580 Y46.290 E19.96374
G1 X33.810 Y45.390 E20.04965
G1 X34.230 Y44.120 E20.17338
G1 X34.560 Y43.310 E20.25427
G1 X35.180 Y42.030 E20.38582
G1 X35.700 Y41.140 E20.48115
G1 X36.580 Y39.870 E20.62406
G1 X37.210 Y39.090 E20.71680
G1 X38.345 Y37.889 E20.86958
G1 F1800.000 E19.86958
G92 E0
G1 X49.140 Y39.844 F7800.000
G1 F1800.000 E1.00000
M106 S255
G92 E0
'''
        out.write(prelude)

def write_postlude(out_name):
    with open(out_name, 'a') as out:
        end = """G92 E0
        G1 F1800.000 E0.12842
        G92 E0
        M107
        M104 S0 ; turn off temperature
        G28 X0  ; home X axis
        M84     ; disable motors
        """
        out.write(end)

def write_perims(out_name, perims, e, ext_fil_ratio, offset=[50.,50.]):
    hist = -1
    component = []
    for i in perims:
        i = map(tuple, i)
        i[0] = (i[0][0], i[0][1])
        i[1] = (i[1][0], i[1][1])
        if hist == -1:
          hist = i[0]
        component.append(i[0])
        # component.append(i[1])
        if i[1] == hist:
            # print 'here'
            # print i, hist, i[0], i[1], i[1] == hist
            component.append(i[1])
            e = make_gcode(component, e, out_name, offset, ext_fil_ratio)
            component = []
            hist = -1
    return e

if __name__ == '__main__':
    f = open(sys.argv[1], 'r')
    out = open('out.gcode', 'w')

    a = ast.literal_eval(f.readline())

    hist = -1
    component = []

    write_prelude('out.gcode')

    e = 1.0
    for i in a:
        i = map(tuple, i)
        i[0] = (4.5*i[0][0], 4.5*i[0][1])
        i[1] = (4.5*i[1][0], 4.5*i[1][1])
        if hist == -1:
          hist = i[0]
        component.append(i[0])
        # component.append(i[1])
        if i[1] == hist:
            # print 'here'
            # print i, hist, i[0], i[1], i[1] == hist
            component.append(i[1])
            e = make_gcode(component, e)
            component = []
            hist = -1

    write_postlude('out.gcode')
